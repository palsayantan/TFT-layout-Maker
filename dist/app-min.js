class ColorCalculator{constructor(){this.colorPicker=document.querySelector("#color-picker"),this.bgColorPicker=document.querySelector("#bg-color-picker"),this._transparentBgCb=document.querySelector("#transparent-bg-cb"),this._defaultColorPicker=document.querySelector("#shape-default-color-input")}ToRgb565(e){const t=e||this.colorPicker.value;let r=(((248&parseInt("0x"+t[1]+t[2]))<<8)+((252&parseInt("0x"+t[3]+t[4]))<<3)+((248&parseInt("0x"+t[5]+t[6]))>>3)).toString(16);for(;r.length<4;)r="0"+r;return"0x"+r.toUpperCase()}ToRgb888(){return"#"+this.colorPicker.value.toString().substring(1,7)}syncPickers(){this._defaultColorPicker.value=this.colorPicker.value}setColor(e){this.colorPicker.value=e}getBackgroundColor(){return this.bgColorPicker.disabled=this._transparentBgCb.checked,this._transparentBgCb.checked?"transparent":this.bgColorPicker.value}setBackgroundColor(e){let t="transparent"===e;this._transparentBgCb.checked=t,this.bgColorPicker.value=t?"#ffffff":e,this.bgColorPicker.disabled=this._transparentBgCb.checked}}let colorCalc=new ColorCalculator;class ShapesBuilder{constructor(){this._defaultColorPicker=document.querySelector("#shape-default-color-input"),this._defaultStrokeWidth=3,this._defaultTextSize=document.querySelector("#text-size")}createRectangleFilled(e=0){const t=new Konva.Rect({x:workarea.grid.padding,y:workarea.grid.padding,width:Math.round(workarea.grid.numPixelsX/20)*workarea.grid.padding,height:Math.round(workarea.grid.numPixelsY/20)*workarea.grid.padding,name:0===e?shapes.RectFilled:shapes.RoundRectFilled,tftCode:0===e?function(){return`tft.fillRect(${Math.round(this.x)},${Math.round(this.y)},${this.width},${this.height},${colorCalc.ToRgb565(this.color)});`}:function(){return`tft.fillRoundRect(${Math.round(this.x)},${Math.round(this.y)},${this.width},${this.height},${this.cornerRadius},${colorCalc.ToRgb565(this.color)});`},color:this._defaultColorPicker.value,fill:this._defaultColorPicker.value,transformAnchors:["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"],draggable:!0,dragBoundFunc:function(e){return{x:e.x<0?0:e.x,y:e.y<0?0:e.y}},cornerRadius:e,strokeScaleEnabled:!1});return setupShapeEvents(t),t}createRectangle(e=0){const t=new Konva.Rect({x:workarea.grid.padding,y:workarea.grid.padding,width:Math.round(workarea.grid.numPixelsX/20)*workarea.grid.padding,height:Math.round(workarea.grid.numPixelsY/20)*workarea.grid.padding,name:0===e?shapes.Rect:shapes.RoundRect,tftCode:0===e?function(){return`tft.drawRect(${Math.round(this.x)},${Math.round(this.y)},${this.width},${this.height},${colorCalc.ToRgb565(this.color)});`}:function(){return`tft.drawRoundRect(${Math.round(this.x)},${Math.round(this.y)},${this.width},${this.height},${this.cornerRadius},${colorCalc.ToRgb565(this.color)});`},draggable:!0,dragBoundFunc:function(e){return{x:e.x<0?0:e.x,y:e.y<0?0:e.y}},cornerRadius:e,transformAnchors:["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"],strokeScaleEnabled:!1,stroke:this._defaultColorPicker.value,strokeWidth:this._defaultStrokeWidth,color:this._defaultColorPicker.value});return setupShapeEvents(t),t}createTriangleFilled(){let e=new Konva.Shape({x:workarea.grid.padding,y:workarea.grid.padding,width:70,height:70,sceneFunc:function(e,t){let r=t.height(),a=t.width();e.beginPath(),e.moveTo(0,r),e.lineTo(a/2,0),e.lineTo(a,r),e.closePath(),e.fillStrokeShape(t)},draggable:!0,strokeScaleEnabled:!1,transformAnchors:["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"],name:shapes.TriangleFilled,color:this._defaultColorPicker.value,fill:this._defaultColorPicker.value,tftCode:function(){return`tft.fillTriangle(${Math.round(this.x)},${Math.round(this.y+this.height)},${Math.round(this.x+this.width/2)},${Math.round(this.y)},${Math.round(this.x+this.width)},${Math.round(this.y+this.height)},${colorCalc.ToRgb565(this.color)});`}});return e.getSelfRect=function(){return{x:0,y:0,width:e.width(),height:e.height()}},setupShapeEvents(e),e}createTriangle(){let e=new Konva.Shape({x:workarea.grid.padding,y:workarea.grid.padding,width:70,height:70,sceneFunc:function(e,t){let r=t.height(),a=t.width();e.beginPath(),e.moveTo(0,r),e.lineTo(a/2,0),e.lineTo(a,r),e.closePath(),e.fillStrokeShape(t)},draggable:!0,strokeScaleEnabled:!1,name:shapes.Triangle,transformAnchors:["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"],color:this._defaultColorPicker.value,tftCode:function(){return`tft.drawTriangle(${Math.round(this.x)},${Math.round(this.y+this.height)},${Math.round(this.x+this.width/2)},${Math.round(this.y)},${Math.round(this.x+this.width)},${Math.round(this.y+this.height)},${colorCalc.ToRgb565(this.color)});`},strokeWidth:this._defaultStrokeWidth,stroke:this._defaultColorPicker.value});return e.getSelfRect=function(){return{x:0,y:0,width:e.width(),height:e.height()}},setupShapeEvents(e),e}createCircleFilled(){const e=new Konva.Circle({x:5*workarea.grid.padding,y:5*workarea.grid.padding,radius:4*workarea.grid.padding,name:shapes.CircleFilled,tftCode:function(){return`tft.fillCircle(${Math.round(this.x)},${Math.round(this.y)},${this.radius},${colorCalc.ToRgb565(this.color)});`},draggable:!0,dragBoundFunc:function(e){return{x:e.x<0?0:e.x,y:e.y<0?0:e.y}},strokeScaleEnabled:!1,transformAnchors:["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"],color:this._defaultColorPicker.value,fill:this._defaultColorPicker.value});return setupShapeEvents(e),e}createCircle(){const e=new Konva.Circle({x:5*workarea.grid.padding,y:5*workarea.grid.padding,radius:4*workarea.grid.padding,name:shapes.Circle,tftCode:function(){return`tft.drawCircle(${Math.round(this.x)},${Math.round(this.y)},${this.radius},${colorCalc.ToRgb565(this.color)});`},draggable:!0,dragBoundFunc:function(e){return{x:e.x<0?0:e.x,y:e.y<0?0:e.y}},strokeScaleEnabled:!1,transformAnchors:["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"],strokeWidth:this._defaultStrokeWidth,color:this._defaultColorPicker.value,stroke:this._defaultColorPicker.value});return setupShapeEvents(e),e}createHLine(){const e=new Konva.Line({points:[0,0,3*workarea.grid.padding,0],x:workarea.grid.padding,y:workarea.grid.padding,name:shapes.HLine,tftCode:function(){return`tft.drawFastHLine(${Math.round(this.x)},${Math.round(this.y)},${this.points[2]-this.points[0]},${colorCalc.ToRgb565(this.color)});`},color:this._defaultColorPicker.value,draggable:!0,transformAnchors:["middle-right","middle-left"],strokeWidth:this._defaultStrokeWidth,hitStrokeWidth:10,stroke:this._defaultColorPicker.value,strokeScaleEnabled:!1});return e.getSelfRect=function(){return{x:e.points()[0],y:e.points()[0]-5,width:e.points()[2]-e.points()[0],height:10}},setupShapeEvents(e),e}createVLine(){const e=new Konva.Line({points:[0,0,0,3*workarea.grid.padding],x:workarea.grid.padding,y:workarea.grid.padding,name:shapes.VLine,tftCode:function(){return`tft.drawFastVLine(${Math.round(this.x)},${Math.round(this.y)},${this.points[3]-this.points[1]},${colorCalc.ToRgb565(this.color)});`},color:this._defaultColorPicker.value,draggable:!0,strokeWidth:this._defaultStrokeWidth,hitStrokeWidth:10,stroke:this._defaultColorPicker.value,strokeScaleEnabled:!1,transformAnchors:["top-center","bottom-center"]});return e.getSelfRect=function(){return{x:e.points()[0]-5,y:e.points()[0],width:10,height:e.points()[3]-e.points()[1]}},setupShapeEvents(e),e}createLine(e=!1){const t=new Konva.Line({points:e?[0,2*workarea.grid.padding,3*workarea.grid.padding,0]:[0,0,3*workarea.grid.padding,3*workarea.grid.padding],x:workarea.grid.padding,y:workarea.grid.padding,name:e?shapes.BottomTopLine:shapes.TopBottomLine,tftCode:function(){return`tft.drawLine(${Math.round(this.x)},${Math.round(this.y+this.points[1])},${Math.round(this.x+this.points[2])},${Math.round(this.y+this.points[3])},${colorCalc.ToRgb565(this.color)});`},color:this._defaultColorPicker.value,draggable:!0,transformAnchors:["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"],strokeWidth:this._defaultStrokeWidth,hitStrokeWidth:10,stroke:this._defaultColorPicker.value,strokeScaleEnabled:!1});return setupShapeEvents(t),t}createText(){let e=this._defaultTextSize;const t=new Konva.Text({x:workarea.grid.padding,y:workarea.grid.padding,name:shapes.TextString,tftCode:function(){return"default"===this.textSize?`${this.printColor()}<br>tft.drawString("${this.text}",${Math.round(this.x)},${Math.round(this.y)});`:`${this.printColor()}<br>tft.drawString("${this.text}",${Math.round(this.x)},${Math.round(this.y)},${this.textSize});`},color:this._defaultColorPicker.value,backgroundColor:"transparent",fill:this._defaultColorPicker.value,draggable:!0,dragBoundFunc:function(e){return{x:e.x<0?0:e.x,y:e.y<0?0:e.y}},text:"New text",fontFamily:"Freesans, Mono, Monospaced, Monospace, Monaco",letterSpacing:.2,fontSize:8*+e.value,textSize:"default",transformAnchors:["top-center","bottom-center","middle-right","middle-left"],setTextSize:function(t){this.textSize=t,this.fontSize="default"===t?8*+e.value:8*+t,this.width=this.textWidth,this.height=this.textHeight,this.text=this.text+" ",workarea.batchDrawShapesLayer()},printColor(){return"transparent"!==this.backgroundColor?`tft.setTextColor(${colorCalc.ToRgb565(this.color)},${colorCalc.ToRgb565(this.backgroundColor)});`:`tft.setTextColor(${colorCalc.ToRgb565(this.color)});`}});return setupShapeEvents(t),t}createChar(){let e=this._defaultTextSize;const t=new Konva.Text({x:workarea.grid.padding,y:workarea.grid.padding,name:shapes.Char,tftCode:function(){return"default"===this.textSize?`tft.drawChar(${Math.round(this.x)},${Math.round(this.y)},'${this.text}',${colorCalc.ToRgb565(this.color)},${colorCalc.ToRgb565(this.backgroundColor)},${+e.value});`:`tft.drawChar(${Math.round(this.x)},${Math.round(this.y)},'${this.text}',${colorCalc.ToRgb565(this.color)},${colorCalc.ToRgb565(this.backgroundColor)},${this.textSize});`},color:this._defaultColorPicker.value,backgroundColor:"transparent",fill:this._defaultColorPicker.value,draggable:!0,transformAnchors:["top-center","bottom-center","middle-right","middle-left"],dragBoundFunc:function(e){return{x:e.x<0?0:e.x,y:e.y<0?0:e.y}},text:"A",fontFamily:"Freesans, Mono, Monospaced, Monospace, Monaco",letterSpacing:.2,fontSize:8*+e.value,textSize:"default",setTextSize:function(t){this.textSize=t,this.fontSize="default"===t?8*+e.value:8*+t,this.width=this.textWidth,this.height=this.textHeight,this.text=this.text+" ",workarea.batchDrawShapesLayer()}});return setupShapeEvents(t),t}createBitmap(){const e=workarea.currentFileLocalPath;let t=new Image;t.src=workarea.currentFile,t.onload=function(){let r=new Konva.Image({image:t,x:workarea.grid.padding,y:workarea.grid.padding,name:shapes.Bitmap,draggable:!0,transformAnchors:["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"],localPath:e,tftCode:function(){return`drawBMP("/${this.localPath}",${this.x},${this.y});`},dragBoundFunc:function(e){return{x:e.x<0?0:e.x,y:e.y<0?0:e.y}}});setupShapeEvents(r),workarea.addShape(r)}}createShape(e){switch(e){case shapes.RectFilled:return this.createRectangleFilled();case shapes.Rect:return this.createRectangle();case shapes.RoundRectFilled:return this.createRectangleFilled(10);case shapes.RoundRect:return this.createRectangle(10);case shapes.TriangleFilled:return this.createTriangleFilled();case shapes.Triangle:return this.createTriangle();case shapes.CircleFilled:return this.createCircleFilled();case shapes.Circle:return this.createCircle();case shapes.HLine:return this.createHLine();case shapes.VLine:return this.createVLine();case shapes.TopBottomLine:return this.createLine(!1);case shapes.BottomTopLine:return this.createLine(!0);case shapes.TextString:return this.createText();case shapes.Char:return this.createChar();case shapes.Bitmap:return this.createBitmap()}}}let shapesBuilder=new ShapesBuilder;class Workarea{constructor(e,t){Konva.pixelRatio=+document.querySelector("#quality-setting").value,this._zoomAmountLabel=document.querySelector("#zoom-amount"),this._zoomLevel=1,this.scrollSensitivity=3,this._scrollSensitivityInput=document.querySelector("#scroll-sensitivity");let r=new Konva.Stage({container:"workspace",width:e,height:t,draggable:!1});this.currentFile="",this._toggleDraggableButton=document.querySelector("#toggle-draggable-button"),this.grid=new Grid,r.add(this.grid.gridLayer),this.shadowRectangle=new Konva.Rect({name:"shadowRect",x:0,y:0,width:2*this.grid.padding,height:2*this.grid.padding,fill:"#FF7B17",opacity:.6,stroke:"#CF6412",strokeWidth:3,dash:[20,2]}),this.transformer=new Konva.Transformer({rotationSnaps:[0,45,90,135,180,225,270,315],ignoreStroke:!0,keepRatio:!1,name:"shapesTransformer",rotateEnabled:!1,setEnabledAnchorsFromShape:()=>{a.nodes()[0].name()===shapes.HLine?a.enabledAnchors(["middle-right","middle-left"]):a.nodes()[0].name()===shapes.VLine?a.enabledAnchors(["top-center","bottom-center"]):a.nodes()[0].name()===shapes.TextString||a.nodes()[0].name()===shapes.Char?a.enabledAnchors(["top-center","bottom-center","middle-right","middle-left"]):a.enabledAnchors(["top-left","top-center","top-right","middle-right","middle-left","bottom-left","bottom-center","bottom-right"])},boundBoxFunc:function(e,t){return t.width<workarea.grid.padding||t.height<workarea.grid.padding?e:t}}),this._shapesLayer=new Konva.Layer,this._shapesLayer.add(this.shadowRectangle),this._shapesLayer.add(this.transformer),this.shadowRectangle.hide(),r.add(this._shapesLayer);let a=this.transformer,i=this._shapesLayer;r.on("click tap",function(e){if(e.target===r||e.target.getLayer()!==i)return a.nodes([]),void propertyPanel.setProperties(null);const t=e.evt.shiftKey||e.evt.ctrlKey||e.evt.metaKey,o=a.nodes().indexOf(e.target)>=0;if(t||o){if(t&&o){const t=a.nodes().slice();t.splice(t.indexOf(e.target),1),a.nodes(t)}else if(t&&!o){const t=a.nodes().concat([e.target]);a.nodes(t)}}else a.nodes([e.target]),a.attrs.setEnabledAnchorsFromShape()}),this._totalZoomDelta=0,r.on("wheel",e=>{this._totalZoomDelta+=Math.sign(e.evt.deltaY),this._totalZoomDelta<-workarea.scrollSensitivity?(workarea.zoomIn(),this._totalZoomDelta=0):this._totalZoomDelta>workarea.scrollSensitivity&&(workarea.zoomOut(),this._totalZoomDelta=0)}),this.stage=r,this._fitGridToScreen()}setResolution(){let e=this.grid.numPixelsX,t=this.grid.numPixelsY;this.grid.redraw();let r=this.grid.numPixelsX/e,a=this.grid.numPixelsY/t,i=this._shapesLayer.children,o=i.length;for(let e=0;e<o;e++){let t=i[e];"shadowRect"!==t.attrs.name&&"shapesTransformer"!==t.attrs.name&&(t.position({x:t.x()*r,y:t.y()*a}),t.size({width:t.width()*r,height:t.height()*a}))}codeArea.setBaseValues(),this.batchDrawShapesLayer(),this._fitGridToScreen()}resizeGrid(){this.grid.redraw(),codeArea.setBaseValues()}zoomIn(){this._zoomLevel+=.25,this._applyZoom(this._zoomLevel)}zoomOut(){this._zoomLevel-=.25,this._zoomLevel<.5&&(this._zoomLevel=.5),this._applyZoom(this._zoomLevel)}_applyZoom(e){this._zoomAmountLabel.innerHTML=`${100*e}%`,this.stage.scale({x:e,y:e})}addShape(e){this._shapesLayer.add(e),this.transformer.nodes([e]),this.transformer.attrs.setEnabledAnchorsFromShape(),propertyPanel.setProperties(e),codeArea.addShape(e)}batchDrawShapesLayer(){this._shapesLayer.batchDraw()}toggleWorkareaDraggable(){let e="c-move-workspace-button--active";this._toggleDraggableButton.classList.contains(e)?(this._toggleDraggableButton.classList.remove(e),this.stage.draggable(!1)):(this._toggleDraggableButton.classList.add(e),this.stage.draggable(!0))}copyCurrentNode(){this._noShapeSelected()||(this._copiedShape=this.transformer.nodes()[0])}pasteCopiedNode(){if(void 0===this._copiedShape)return;let e=shapesBuilder.createShape(this._copiedShape.name());e.size(this._copiedShape.size()),e.stroke(this._copiedShape.stroke()),e.fill(this._copiedShape.fill()),e.name()!==shapes.Char&&e.name()!==shapes.TextString||e.text(this._copiedShape.text()),e.attrs.textSize=this._copiedShape.attrs.textSize,e.attrs.color=this._copiedShape.attrs.color,e.attrs.backgroundColor=this._copiedShape.attrs.backgroundColor,this.addShape(e)}deleteSelectedNodes(){let e=this.transformer.nodes();this.transformer.nodes().forEach(e=>e.destroy()),this.transformer.nodes([]),codeArea.deleteShapes(e)}_noShapeSelected(){return 0===this.transformer.nodes().length}_fitGridToScreen(){let e=this.stage.width()/this.grid.numPixelsX,t=this.stage.height()/this.grid.numPixelsY,r=Math.min(e,t);r-=r%.25,this._zoomLevel=r,this._applyZoom(this._zoomLevel)}setScrollSensitivity(){this.scrollSensitivity=+this._scrollSensitivityInput.value}setQuality(){Konva.pixelRatio=+document.querySelector("#quality-setting").value,this.resizeGrid()}}document.addEventListener("keydown",function(e){"Escape"===e.key&&workarea.transformer.nodes([]),"c"===e.key&&(e.ctrlKey||e.metaKey)&&workarea.copyCurrentNode(),"v"===e.key&&(e.ctrlKey||e.metaKey)&&workarea.pasteCopiedNode(),"Delete"===e.key&&workarea.deleteSelectedNodes()});const menuItems={Workspace:"workspace",Shapes:"shapes",ShapeProperties:"shapeProps",Export:"export",Settings:"settings"};let menuDivs=document.getElementsByClassName("c-tools-foldout__item"),menuButtons=document.getElementsByClassName("c-tools-panel__button");function showMenu(e){switch(e){case menuItems.Workspace:t(0);break;case menuItems.Shapes:t(1);break;case menuItems.ShapeProperties:t(2);break;case menuItems.Settings:t(3)}function t(e){for(let t=0;t<menuDivs.length;t++)t===e?(menuDivs[t].style.display="block",menuButtons[t].classList.add("c-tools-panel__button--active")):(menuDivs[t].style.display="none",menuButtons[t].classList.remove("c-tools-panel__button--active"))}}class Grid{constructor(){this._lineColor="#888",this._heightInput=document.getElementById("height-input"),this._widthInput=document.getElementById("width-input"),this._paddingInput=document.getElementById("grid-size-input"),this._screenSizeLabel=document.querySelector("#screen-size-label");let e=new Konva.Layer({draggable:!1,name:"grid"});this._createGrid(e),this.gridLayer=e}_createGrid(e){this.numPixelsX=+this._heightInput.value,this.numPixelsY=+this._widthInput.value,this.padding=+this._paddingInput.value;let t=Math.floor(this.numPixelsX/this.padding),r=Math.floor(this.numPixelsY/this.padding),a=r*this.padding,i=t*this.padding;if(1===this.padding)return e.add(new Konva.Line({points:[0,0,0,a],stroke:this._lineColor,strokeWidth:.5})),e.add(new Konva.Line({points:[this.numPixelsX,0,this.numPixelsX,a],stroke:this._lineColor,strokeWidth:.5})),e.add(new Konva.Line({points:[0,0,i,0],stroke:this._lineColor,strokeWidth:.5})),e.add(new Konva.Line({points:[0,a,i,a],stroke:this._lineColor,strokeWidth:.5})),void e.cache();for(let r=0;r<=t;r++)e.add(new Konva.Line({points:[Math.round(r*this.padding),0,Math.round(r*this.padding),a],stroke:this._lineColor,strokeWidth:.1}));for(let t=0;t<=r;t++)e.add(new Konva.Line({points:[0,Math.round(t*this.padding),i,Math.round(t*this.padding)],stroke:this._lineColor,strokeWidth:.1}));e.cache(),this._screenSizeLabel.innerHTML=`Display size: ${this.numPixelsX}x${this.numPixelsY}`}redraw(){this.gridLayer.destroyChildren(),this.gridLayer.clear(),this._createGrid(this.gridLayer),this.gridLayer.batchDraw()}}class PropertyPanel{constructor(){this._xPosLabels=[].slice.call(document.querySelectorAll(".x-pos-label")),this._yPosLabels=[].slice.call(document.querySelectorAll(".y-pos-label")),this._widthLabels=[].slice.call(document.querySelectorAll(".x-size-label")),this._heightLabels=[].slice.call(document.querySelectorAll(".y-size-label")),this._radiusLabels=[].slice.call(document.querySelectorAll(".radius-label")),this._tftCodeLabels=[].slice.call(document.querySelectorAll(".tft-code")),this._xPosInput=document.querySelector("#x-pos-input"),this._yPosInput=document.querySelector("#y-pos-input"),this._widthInput=document.querySelector("#x-size-input"),this._heightInput=document.querySelector("#y-size-input"),this._radiusInput=document.querySelector("#radius-input"),this._textInput=document.querySelector("#text-input"),this._textToolsDiv=document.querySelector(".c-text-tools"),this._textSizeOverrideInput=document.querySelector("#text-size-override"),this._xPosInput.onkeydown=this._applyChanges,this._yPosInput.onkeydown=this._applyChanges,this._widthInput.onkeydown=this._applyChanges,this._heightInput.onkeydown=this._applyChanges,this._radiusInput.onkeydown=this._applyChanges,this._inputTypes=["text","password","number","email","tel","url","search","date","datetime","datetime-local","time","month","week"]}setProperties(e){if(null===e)return this._setElements(),void(this._textToolsDiv.style="display: none");let t;e.name().includes("circle")&&(t=Math.round(e.radius())),e.name().includes("Round")&&(t=Math.round(e.cornerRadius()));let r=Math.round(e.x()),a=Math.round(e.y()),i=Math.round(e.width()*e.scaleX()),o=Math.round(e.height()*e.scaleY());e.name().includes(shapes.TextString)||e.name().includes(shapes.Char)?(this._textToolsDiv.style="display: flex",this._textInput.value=e.text(),this._textSizeOverrideInput.value=e.attrs.textSize,colorCalc.setBackgroundColor(e.attrs.backgroundColor)):this._textToolsDiv.style="display: none";let s=e.attrs.tftCode();e.name()===shapes.TextString&&(s=s.slice(s.indexOf(">")+1)),this._setElements(r,a,i,o,t,e.attrs.color,s)}updateSelectedShape(){if(1!==workarea.transformer.nodes().length)return;let e=workarea.transformer.nodes()[0];this._validateInputs(),e.position({x:+this._xPosInput.value,y:+this._yPosInput.value}),e.size({width:+this._widthInput.value,height:+this._heightInput.value}),e.name().includes(shapes.TextString)&&(e.attrs.setTextSize(this._textSizeOverrideInput.value),e.text(this._textInput.value)),e.name().includes(shapes.Char)&&(e.attrs.setTextSize(this._textSizeOverrideInput.value),this._textInput.value.length>1&&(this._textInput.value=this._textInput.value.charAt(1)),e.text(this._textInput.value)),e.name().includes("circle")&&e.radius(+this._radiusInput.value),e.name().includes("Round")&&e.cornerRadius(+this._radiusInput.value),colorCalc.syncPickers(),e.name().includes("Fill")||e.name().includes("text")||e.name().includes("char")?e.fill(colorCalc.ToRgb888()):e.stroke(colorCalc.ToRgb888()),e.attrs.color=colorCalc.ToRgb888(),(e.name().includes("text")||e.name().includes("char"))&&(e.attrs.backgroundColor=colorCalc.getBackgroundColor()),this.setProperties(e),codeArea.updateShape(e)}removeSelectedShape(){workarea.transformer.nodes()[0].destroy(),workarea.transformer.nodes([]),this._setElements()}_applyChanges(e){"Enter"===e.key&&propertyPanel.updateSelectedShape()}_setElements(e=0,t=0,r=0,a=0,i=0,o="",s=""){this._xPosLabels.forEach(t=>this._setElement(t,"Pos x: ",e)),this._yPosLabels.forEach(e=>this._setElement(e,"Pos y: ",t)),this._widthLabels.forEach(e=>this._setElement(e,"Width: ",r)),this._heightLabels.forEach(e=>this._setElement(e,"Height: ",a)),i>0&&this._radiusLabels.forEach(e=>this._setElement(e,"Radius: ",i)),this._radiusLabels.forEach(e=>e.parentNode.style=i>0?"display: block":"display: none"),this._tftCodeLabels.forEach(e=>e.innerHTML=s),colorCalc.setColor(o)}_setElement(e,t,r){this._isTextBox(e)?e.value=r:e.innerHTML=t+r}_isTextBox(e){let t=e.tagName.toLowerCase();if("textarea"===t)return!0;if("input"!==t)return!1;let r=e.getAttribute("type").toLowerCase();return this._inputTypes.indexOf(r)>=0}_validateInputs(){let e=workarea.grid.padding;this._widthInput.value=+this._widthInput.value<e?e:this._widthInput.value,this._heightInput.value=+this._heightInput.value<e?e:this._heightInput.value,this._radiusInput.value=+this._radiusInput.value<e?e:this._radiusInput.value}}let workarea,propertyPanel=new PropertyPanel;const shapes={Rect:"rectangle",RectFilled:"rectangleFilled",RoundRect:"rectangleRounded",RoundRectFilled:"rectangleRoundedFilled",Triangle:"triangle",TriangleFilled:"triangleFilled",CircleFilled:"circleFilled",Circle:"circle",HLine:"horizontalLine",VLine:"verticalLine",BottomTopLine:"btLine",TopBottomLine:"tbLine",TextString:"text",Char:"char",Bitmap:"bitmap"};function startApp(){let e=window.innerWidth-550,t=window.innerHeight-50;workarea=new Workarea(e,t),document.querySelector("#file-input").onchange=(e=>{workarea.currentFile=URL.createObjectURL(e.target.files[0]),workarea.currentFileLocalPath=e.target.files[0].name,addShape(shapes.Bitmap)})}function addShape(e){let t=shapesBuilder.createShape(e);e!==shapes.Bitmap&&workarea.addShape(t)}function addImage(){document.querySelector("#file-input").click()}function setupShapeEvents(e){e.on("click tap",t=>{propertyPanel.setProperties(e);let r=e.name().includes("circle");workarea.transformer.keepRatio(r),workarea.transformer.centeredScaling(r),workarea.transformer.moveToTop()}),e.on("dragstart",t=>{propertyPanel.setProperties(e),workarea.batchDrawShapesLayer(),1===workarea.grid.padding||e.name().includes("Line")||(workarea.shadowRectangle.setSize(e.getSize()),workarea.shadowRectangle.show(),workarea.shadowRectangle.moveToTop())}),e.on("dragend",t=>{e.position({x:Math.round(e.x()/workarea.grid.padding)*workarea.grid.padding,y:Math.round(e.y()/workarea.grid.padding)*workarea.grid.padding}),propertyPanel.setProperties(e),workarea.batchDrawShapesLayer(),1!==workarea.grid.padding&&(workarea.shadowRectangle.hide(),codeArea.updateShape(e))}),e.on("dragmove",t=>{propertyPanel.setProperties(e),1!==workarea.grid.padding&&(_setShadowRectPos(e),workarea.batchDrawShapesLayer())}),e.on("transformstart",function(){if(workarea.transformer.moveToTop(),1===workarea.grid.padding||e.name().includes("Line"))return;e.name().includes("circle")||(workarea.shadowRectangle.setSize(e.getSize()),_setShadowRectPos(e),workarea.batchDrawShapesLayer(),workarea.shadowRectangle.show(),workarea.shadowRectangle.moveToTop())}),e.on("transform",function(){propertyPanel.setProperties(e);let t=e.name().includes("circle");if((e.name().includes(shapes.TextString)||e.name().includes(shapes.Char))&&e.setAttrs({width:e.width()*e.scaleX(),height:e.height()*e.scaleY(),scaleX:1,scaleY:1}),1===workarea.grid.padding||t)return;let r=e.width()*e.scaleX(),a=e.height()*e.scaleY(),i=Math.round(r/workarea.grid.padding)*workarea.grid.padding,o=Math.round(a/workarea.grid.padding)*workarea.grid.padding;workarea.shadowRectangle.setSize({width:i,height:o}),_setShadowRectPos(e),workarea.batchDrawShapesLayer()}),e.on("transformend",function(){let t=e.width()*e.scaleX(),r=e.height()*e.scaleY();e.name().includes("circle")?(e.radius(Math.round(t/2/workarea.grid.padding)*workarea.grid.padding),e.scaleY(1),e.scaleX(1)):e.name().includes(shapes.HLine)?(e.scaleY(1),e.scaleX(1),e.points([e.points()[0],e.points()[1],Math.round(t/workarea.grid.padding)*workarea.grid.padding,e.points()[3]])):e.name().includes(shapes.VLine)?(e.scaleY(1),e.scaleX(1),e.points([e.points()[0],e.points()[1],e.points()[2],Math.round(r/workarea.grid.padding)*workarea.grid.padding])):e.name()===shapes.TopBottomLine?(e.scaleY(1),e.scaleX(1),e.position({x:Math.round(e.x()/workarea.grid.padding)*workarea.grid.padding,y:Math.round(e.y()/workarea.grid.padding)*workarea.grid.padding}),e.points([e.points()[0],e.points()[1],Math.round(t/workarea.grid.padding)*workarea.grid.padding,Math.round(r/workarea.grid.padding)*workarea.grid.padding])):e.name()===shapes.BottomTopLine?(e.scaleY(1),e.scaleX(1),e.position({x:Math.round(e.x()/workarea.grid.padding)*workarea.grid.padding,y:Math.round(e.y()/workarea.grid.padding)*workarea.grid.padding}),e.points([e.points()[0],Math.round(r/workarea.grid.padding)*workarea.grid.padding,Math.round(t/workarea.grid.padding)*workarea.grid.padding,e.points()[3]])):(e.width(Math.round(t/workarea.grid.padding)*workarea.grid.padding),e.height(Math.round(r/workarea.grid.padding)*workarea.grid.padding),e.scaleY(1),e.scaleX(1),e.position({x:Math.round(e.x()/workarea.grid.padding)*workarea.grid.padding,y:Math.round(e.y()/workarea.grid.padding)*workarea.grid.padding})),propertyPanel.setProperties(e),workarea.shadowRectangle.hide(),codeArea.updateShape(e)})}function _setShadowRectPos(e){e.attrs.name.includes("circle")?workarea.shadowRectangle.position({x:Math.round((e.x()-e.radius())/workarea.grid.padding)*workarea.grid.padding,y:Math.round((e.y()-e.radius())/workarea.grid.padding)*workarea.grid.padding}):workarea.shadowRectangle.position({x:Math.round(e.x()/workarea.grid.padding)*workarea.grid.padding,y:Math.round(e.y()/workarea.grid.padding)*workarea.grid.padding})}startApp();class TftCodeArea{constructor(){this._elements={},this._elementsIndexMap={},this._curShapeIndex=0,this._rotateInput=document.querySelector("#rotate-select"),this._textSizeInput=document.querySelector("#text-size"),this._settingsArea=document.querySelector("#settings-output-area"),this._shapesArea=document.querySelector("#shapes-output-area"),this.setBaseValues(),this._lastTextColor=void 0}setDefaultTextSize(){let e=workarea.stage.find("."+shapes.TextString);for(let t=0;t<e.length;t++)e[t].attrs.setTextSize("default");e=workarea.stage.find("."+shapes.Char);for(let t=0;t<e.length;t++)e[t].attrs.setTextSize("default");this.setBaseValues()}setBaseValues(){for(;this._settingsArea.firstChild;)this._settingsArea.removeChild(this._settingsArea.firstChild);this._settingsArea.appendChild(this._createNode("#define TFT_HEIGHT "+workarea.grid.numPixelsY+";")),this._settingsArea.appendChild(this._createNode("#define TFT_WIDTH "+workarea.grid.numPixelsX+";")),this._settingsArea.appendChild(this._createNode("&nbsp;")),this._settingsArea.appendChild(this._createNode("tft.init();")),this._settingsArea.appendChild(this._createNode(`tft.setRotation(${+this._rotateInput.value});`)),this._settingsArea.appendChild(this._createNode(`tft.setTextSize(${+this._textSizeInput.value});`)),this._settingsArea.appendChild(this._createNode("tft.fillScreen(0x0000);")),this._settingsArea.appendChild(this._createNode("&nbsp;"))}_createNode(e){let t=document.createElement("span");return t.classList.add("code-element"),t.innerHTML=e,t}addShape(e){this._elements[e._id]=e,this._elementsIndexMap[e._id]=this._getIndexForNewShape();let t=e.attrs.tftCode();if(e.name()===shapes.TextString){let r=this._getPreviousTextElement(e._id);if(null!==r){let a=r.attrs.color,i=r.attrs.backgroundColor;a===e.attrs.color&&i===e.attrs.backgroundColor&&(t=t.slice(t.indexOf(">")+1))}}this._shapesArea.appendChild(this._createNode(t))}updateShape(e){let t=this._elementsIndexMap[e._id];this._elements[e._id]=e;let r=e.attrs.tftCode();if(e.name()===shapes.TextString){this.deleteShapes(null);let t=this._getPreviousTextElement(e._id);if(null!==t){let a=t.attrs.color,i=t.attrs.backgroundColor;a===e.attrs.color&&i===e.attrs.backgroundColor&&(r=r.slice(r.indexOf(">")+1))}}this._shapesArea.children[t].innerHTML=r}_getIndexForNewShape(){return this._curShapeIndex++,this._curShapeIndex-1}deleteShapes(e){if(null!==e){let t=e.map(e=>e._id);for(let e=0;e<t.length;e++)delete this._elements[t[e]]}for(this._curShapeIndex=0,this._elementsIndexMap={};this._shapesArea.firstChild;)this._shapesArea.removeChild(this._shapesArea.firstChild);for(let e in this._elements)this.addShape(this._elements[e])}copyAll(){let e="";this._settingsArea.childNodes.forEach(t=>e+="&nbsp;"===t.innerHTML?"\r\n":t.innerHTML+"\r\n"),this._shapesArea.childNodes.forEach(t=>e+=t.innerHTML+"\r\n"),e=e.replaceAll("<br>","\r\n"),this._copyStringToClipboard(e)}_copyStringToClipboard(e){let t=document.createElement("textarea");t.value=e,t.setAttribute("readonly",""),t.style={position:"absolute",left:"-9999px"},document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),alert("Copied to clipboard: \r\n"+e)}_getPreviousTextElement(e){let t=null;for(let r in this._elementsIndexMap){if(+r==+e)return t;let a=this._elements[r];a.name()===shapes.TextString&&(t=a)}return null}}let codeArea=new TftCodeArea;